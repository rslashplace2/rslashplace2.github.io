<!DOCTYPE html>
<html lang="en" ontouchstart="if(!chatPanel.contains(event.target))event.preventDefault()" ontouchend="event.preventDefault()">
<head>
	<link rel="manifest" href="manifest.json">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link rel="apple-touch-icon" href="favicon.png">
	<meta name="apple-mobile-web-app-title" content="place">
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="style.css" rel="stylesheet">
	<title>place</title>
	<link rel="icon" type="image/x-icon" href="favicon.png">
<meta property="og:title" content="r/place 2" />
<meta property="og:description" content="I honestly nearly cried when r/place ended so here is a faithful recreation with the same map for you all to have fun on!" />
<meta property="og:image" content="https://preview.redd.it/rreqw9qpy8r81.png?auto=webp&s=f58d371c5505d66439c82de9040dfd99a3685015" />
<meta name="theme-color" content="#ff4500">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5065501786618884" crossorigin="anonymous"></script>
</head>
	<body onkeypress="scanDocumentShortcuts(event)">
		<div id="donate" noselect onclick="window.open('https://bit.ly/3LVwDtW','_blank')">Donate</div>
		<div id="posel" noselect>(0,0) 2.5x</div>
		<div id="serverMenu" style="transform: translateX(-50%) translateY(-200px)">
			<h2 title="Switch to an official secondary or private game server." style="display: inline;">Switch Game Server:</h2>
			<icon-close noselect="" id="close-btn" onclick="serverInput.blur(); serverMenu.style.transform = 'translateX(-50%) translateY(-200px)'; serverMenu.opened = false;" class="active" style="flex: initial; position: absolute; right: 10px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="active"><path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z" class=""></path></svg></icon-close>
			<br><br>
			<input id="serverInput" type="text" placeholder="server.rplace.tk" onkeypress="if(event.keyCode==13)switchGameServer(this.value), this.value=''">
		</div>
		<div id="place" noselect onclick="if(CD<Date.now())zoomIn(),showPalette();else audios.invalid.run()">Connecting...</div>
		<div id="chat" noselect onclick="showChat()">Chat</div>
		<div id="chatPanel" style="visibility: visible; transform: translateX(calc(100% + 50px));">
			<div id="namePanel" style="position: absolute; top: 50%; transform: translateY(-50%); text-align: center; width: calc(100% - 20px); padding: 10px; background-color: white; border-radius: 15px; height: 120px;">
				<h2>Enter a nickname to continue:</h2>
				<h4 style="color: lightgrey;">Devam etmek iÃ§in bir takma ad girin:</h4>
				<br>
				<div>
					<input id="nameInput" type="text" placeholder="Enter nickname..." onkeypress="if(event.keyCode==13)setName(this.value),this.value=''" maxlength="15">
					<button id="nameSubmit" onclick="setName(nameInput.value)"><svg enable-background="new 0 0 55.702 55.702" version="1.1" viewBox="0 0 55.702 55.702" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"><g fill="lightgrey"><path d="M27.851,0C12.494,0,0,12.494,0,27.851s12.494,27.851,27.851,27.851s27.851-12.494,27.851-27.851   C55.701,12.494,43.208,0,27.851,0z M27.851,51.213c-12.882,0-23.362-10.48-23.362-23.363c0-12.882,10.48-23.362,23.362-23.362   s23.362,10.481,23.362,23.363S40.733,51.213,27.851,51.213z"/><path d="m36.729 18.97-13 13.001-4.757-4.757c-0.876-0.877-2.297-0.877-3.173 0-0.877 0.876-0.877 2.297 0 3.173l6.344 6.344c0.438 0.438 1.013 0.658 1.587 0.658s1.148-0.219 1.586-0.658l14.587-14.587c0.876-0.877 0.876-2.297 0-3.174-0.877-0.876-2.297-0.876-3.174 0z"/></g></svg></button>
				</div>
			</div>
			<div style="display: flex; flex-direction: row;" noselect>
				<h2 style="flex: auto;">Live Chat:</h2>
				<div style="height:30px; width: 180px; border-radius: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.4); display: flex; flex-direction: row; margin-right: 20px; cursor: pointer;">
					<!-- Flag emojis all sourced from openmoji.org, have all been minified in order to reduce HTML size, see https://openmoji.org/library/#emoji=1F1EC-1F1E7, https://openmoji.org/library/#group=flags&emoji=1F1F9-1F1F7-->
					<span id="channelFas" style="flex: auto; line-height: 30px; text-align: center; border-radius: 20px 0px 0px 20px; background-color: transparent; opacity: 1;" onclick="switchLanguageChannel('fas')">ÙØ§Ø±Ø³ÛŒ FAS</span>
					<span id="channelTu" style="flex: auto; line-height: 30px; text-align: center; border-radius: 20px 0px 0px 20px; background-color: transparent; opacity: 0.5;" onclick="switchLanguageChannel('tu')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72" style="height: 20px; display: inline; top: 5px; position: relative;"><path fill="#d22f27" d="M5 17h62v38H5z"/><g fill="#fff" stroke="#fff" stroke-linejoin="round"><path stroke-linecap="round" d="M40.64 33.05l3.052 4.019-4.934-1.532 4.932-1.541-3.046 4.025-.004-4.972"/><path d="M31.29 44.64a8.643 8.643 0 1 1 3.958-16.34 11 11 0 1 0 0 15.38 8.715 8.715 0 0 1-3.958.951z"/></g><path fill="none" stroke="#000" stroke-linejoin="round" stroke-width="2" d="M5 17h62v38H5z"/></svg>TÃœ</span>
					<span id="channelEn" style="flex: auto; line-height: 30px; text-align: center; border-radius: 0px 20px 20px 0px; background-color: transparent; opacity: 0.5;" onclick="switchLanguageChannel('en')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72" style="height: 20px; display: inline; top: 5px; position: relative;"><path fill="#1e50a0" d="M5 17h62v38H5z"/><path fill="#fff" d="M40 28.856V32h10.181L67 21.691V17h-7.654L40 28.856z"/><path fill="#d22f27" d="M67 17h0-3.827L40 31.203V32h3.482L67 17.586V17z"/><path fill="#fff" d="M59.347 55H67h0v-4.692L50.182 40H40v3.143L59.347 55z"/><path fill="#d22f27" d="M67 55v-2.347L46.355 40h-4.787l24.474 15H67h0z"/><path fill="#fff" d="M32 43.144V40H21.819L5 50.309V55h7.654L32 43.144z"/><path fill="#d22f27" d="M5 55h0 3.827L32 40.797V40h-3.482L5 54.414V55z"/><path fill="#fff" d="M12.653 17H5h0v4.692L21.818 32H32v-3.143L12.653 17z"/><path fill="#d22f27" d="M5 17v2.347L25.646 32h4.786L5.958 17H5h0z"/><g fill="#fff"><path d="M5 31h62v10H5z"/><path d="M31 17h10v38H31z"/></g><g fill="#d22f27"><path d="M5 33h62v6H5z"/><path d="M33 17h6v38h-6z"/></g><path fill="none" stroke="#000" stroke-linejoin="round" stroke-width="2" d="M5 17h62v38H5z"/></svg>EN</span>
				</div>
				<div id="onlinepanel" noselect> <p id="onlineCounter">...</p> <svg id="playerIcon" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg" style="display: inline;"><path d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0 96 57.3 96 128s57.3 128 128 128zm89.6 32h-16.7c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16h-16.7C60.2 288 0 348.2 0 422.4V464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48v-41.6c0-74.2-60.2-134.4-134.4-134.4z"></path></svg> </div>
				<icon-close noselect="" id="close-btn" onclick="messageInput.blur(); hideChat()" class="active" style="flex: initial;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="active"><path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z" class=""></path></svg></icon-close>
			</div>
			<hr style="margin-top: 10px;">
			<span style="color: red;">[!] </span><span id="channelNotification">Ù„Ø·ÙØ§ Ø§Ø² 'en' Ø¨Ø±Ø§ÛŒ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ 'tu' Ø¨Ø±Ø§ÛŒ ØªØ±Ú©ÛŒ Ùˆ 'far' Ø¨Ø±Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯</span>
			<hr>
			<br>
			<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7492601452630734" crossorigin="anonymous"></script>
			<!-- Chat Ad -->
			<div><ins class="adsbygoogle"
				style="display:block"
				data-ad-client="ca-pub-5065501786618884"
				data-ad-slot=""
				data-ad-format="auto"
				data-full-width-responsive="true" style="position: relative">
				<!--custom ad for now-->
				<div style="background: url(https://pxlsfiddle.com/pxlsarchive/canvas41/final.png) 50%/cover;height: 100%;filter: blur(1px) brightness(0.5);"></div><div style="position: absolute;top: 0;color: white;font-size: 25px;text-align: center;left: 0;right: 0;margin-top: 40px;">We're at <em>WAR</em> with <a href="https://pxls.space" target="blank" style="color: #88f;">pxls.space</a><div style="font-size: 17px;color: #aaa;">pxls.space ile savaÅŸtayÄ±z<br>SanatlarÄ±nÄ± bayraklarla Ã¶rtÃ¼n!</div></div>
				</ins>
			</div>
			<script>
				//(adsbygoogle = window.adsbygoogle || []).push({});
				setInterval(()=>{chatPanel.style.height="calc(100% - 85px)";let ad=document.querySelector(".adsbygoogle").style;ad.height="150px";ad.position="relative"},100)
			</script>
			<div id="chatMessages" style="overflow-wrap: break-word; word-wrap: break-word; font-family:mono;white-space: pre-wrap; max-height: calc(100% - 300px); overflow: auto; z-index: -1;"></div>
			<input id="messageInput" type="text" placeholder="Enter message..." enterkeyhint="send" onkeypress="if(event.keyCode==13)sendMsg(this.value),this.value=''" maxlength="200">
		</div>
		<canvas id="canvas" width="0" height="0" noselect></canvas>
		<div id="canvparent1" noselect>
			<img id="edge" height="226" width="290" src="https://www.redditstatic.com/mona-lisa/assets/img/snoo-edge.png" />
		</div>
		<div id="canvparent2" noselect>
			<div id="canvselect">
				<svg fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" height="120%" width="120%" style="position: absolute;top: -10%;left: -10%;">
					<g stroke-opacity=".6" stroke-width="2"> <g stroke="#000"> <path d="m3 9v-6h6"></path> <path d="m14.9999 3h6v6"></path> <path d="m20.9999 15.0001v6h-6"></path> <path d="m9 21.0001h-6v-6"></path> </g> <path d="m1 9v-8h8" stroke="#fff"></path> <path d="m15 1h8v8" stroke="#fff"></path> <path d="m23 15v8h-8" stroke="#fff"></path> <path d="m9 23h-8v-8" stroke="#fff"></path> </g>
				</svg>
			</div>
		</div>
		<div noselect id="helpbtn" onclick="if(modal.style.display=='flex'){modal.style.display='none';bg.style.display='none'}else{modal.style.display='flex';bg.style.display='block'}"><svg xmlns="http://www.w3.org/2000/svg" data-name="icons final" viewBox="0 0 20 20"><path d="M10 .875A9.125 9.125 0 1019.125 10 9.135 9.135 0 0010 .875zm0 17A7.875 7.875 0 1117.875 10 7.884 7.884 0 0110 17.875z"></path><path d="M10.479 13.635a1.085 1.085 0 00-.547-.141 1.035 1.035 0 00-.537.145 1.009 1.009 0 00-.379.388 1.1 1.1 0 00-.137.547 1.018 1.018 0 00.143.533 1.045 1.045 0 00.387.38 1.056 1.056 0 00.536.14 1.076 1.076 0 00.54-.14 1.008 1.008 0 00.387-.385 1.08 1.08 0 00.14-.541 1.05 1.05 0 00-.533-.926zM11.507 5.641a3.213 3.213 0 00-1.425-.309 3.15 3.15 0 00-1.535.368 2.646 2.646 0 00-1.028.974 2.52 2.52 0 00-.363 1.312h1.463a1.172 1.172 0 01.181-.661 1.327 1.327 0 01.516-.468 1.623 1.623 0 011.415-.017 1.212 1.212 0 01.5.431 1.1 1.1 0 01.181.618 1.063 1.063 0 01-.119.5 1.56 1.56 0 01-.3.4 9.531 9.531 0 01-.492.43 6.846 6.846 0 00-.656.585 2.292 2.292 0 00-.431.656 2.206 2.206 0 00-.178.919v.766h1.429v-.793a1.281 1.281 0 01.13-.58 1.824 1.824 0 01.321-.459c.128-.132.3-.3.533-.493a7.691 7.691 0 00.633-.584 2.279 2.279 0 00.41-.622 2.015 2.015 0 00.167-.85A2.262 2.262 0 0012.5 6.5a2.41 2.41 0 00-.993-.859z"></path></svg></div>
		<div id="bg" style="display:none;position:fixed;top:0;left:0;bottom:0;right:0;background:rgba(0,0,0,.4);z-index:6"></div>
		<div id="modal" style="display:none"><div id="modal-header"> <h2>Place</h2> <icon-close noselect id="close-btn" onclick="modal.style.display='none';bg.style.display='none'"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z"></path></svg></icon-close> </div> <div id="modal-content">There is an empty canvas.<br><br>You may place a tile upon it, but you must wait to place another.<br><br>Individually you can create something.<br><br>Together you can create something more.</div> <div> <a onclick="window.open('https://discord.gg/dgEF6wvBzj','_blank')">Discord</a><span onclick='localStorage.vip=prompt("Enter key?")'>&nbsp;/&nbsp;</span><a onclick="window.open('https:\/\/www.reddit.com/r/placetk','_blank')">Subreddit</a> </div> <div id="modal-footer"> <mute-button noselect onclick="muted=!muted;mutesvg.innerHTML=muted?mutedhtml:unmutedhtml"><svg xmlns="http://www.w3.org/2000/svg" id="mutesvg" viewBox="0 0 20 20"></svg></mute-button><img noselect alt="Place Logo" height="40" width="40" src="https://www.redditstatic.com/mona-lisa/assets/img/place-logo.svg" /></div> </div>
		<div id="palette" style="transform: translateY(100%)" noselect>
			<div id="colors">

			</div>
			<div class="buttons">
				<div class="pcancel" onclick="audios.closePalette.run();canvselect.style.background='';palette.style.transform='translateY(100%)';if(PEN!=-1){colors.children[PEN].classList.remove('sel');PEN=-1};pok.classList.remove('enabled');canvselect.children[0].style.display='block';canvselect.style.outline='';canvselect.style.boxShadow=''; hideIndicators()"><svg xmlns="http://www.w3.org/2000/svg" data-name="icons final" viewBox="0 0 20 20"><path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z"></path></svg></div>
				<div id="pok" class="pok" onclick="if(!this.classList.contains('enabled'))return; put(); hideIndicators()"><svg xmlns="http://www.w3.org/2000/svg" data-name="icons final" viewBox="0 0 20 20"><path d="M7.5 15.583a.72.72 0 01-.513-.212L1.558 9.942l.884-.884L7.5 14.116 18.058 3.558l.884.884L8.013 15.371a.72.72 0 01-.513.212z"></path></svg></div>
			</div>
		</div>
	</body>
	<script>
		const PALETTE = [0xff1a006d,0xff3900be,0xff0045ff,0xff00a8ff,0xff35d6ff,0xffb8f8ff,0xff68a300,0xff78cc00,0xff56ed7e,0xff6f7500,0xffaa9e00,0xffc0cc00,0xffa45024,0xffea9036,0xfff4e951,0xffc13a49,0xffff5c6a,0xffffb394,0xff9f1e81,0xffc04ab4,0xffffabe4,0xff7f10de,0xff8138ff,0xffaa99ff,0xff2f486d,0xff26699c,0xff70b4ff,0xff000000,0xff525251,0xff908d89,0xffd9d7d4,0xffffffff]
		const WIDTH = 2000
		const HEIGHT = 2000
		let COOLDOWN = 10e3
	</script>

	<script>
		let actives = new Map()
		actives.set(-2, [])
		let touch1 = null, touch2 = null, touchmoved = 3;
		document.body.ontouchstart = function(e){
			for(let t of e.changedTouches){
				if(!touch1)touch1 = t, touchmoved = 3
				else if(!touch2)touch2 = t
				else [touch1, touch2] = [touch2, t]
				let ac = []
				let el = e.target
				while(el){
					el.classList.add("active")
					ac.push(el)
					el = el.parentElement
				}
				actives.set(t.identifier, ac)
			}
		}
		document.body.ontouchend = function(e){
			for(let t of e.changedTouches){
				a: if(touch2 && touch2.identifier == t.identifier)touch2 = null
				else if(touch1 && touch1.identifier == t.identifier){
					[touch1, touch2] = [touch2, null]
					if(touchmoved > 0 && canvparent2.contains(e.target)){
						if(e.target != document.body && !canvparent2.contains(e.target))break a
						clicked(t.clientX, t.clientY)
					}
				}
				for(let el of actives.get(t.identifier))el.classList.remove("active")
				actives.delete(t.identifier)
				if('value' in e.target)e.target.focus()
				else{let target = e.target; while(!target.click)target = target.parentElement;target.click()}
			}
		}
		let moved = 3
		document.body.onmousedown = function(e){
			moved = 3
			click = e.button + 1
		}
		document.body.onmouseup = function(e){
			if(e.target != document.body && !canvparent2.contains(e.target))return (moved = 3, click = 0)
			if(moved > 0 && canvparent2.contains(e.target)){
				clicked(e.clientX, e.clientY)
			}
			moved = 3
			click = 0
		}
		oncontextmenu = e => e.preventDefault()
		let selX = 0, selY = 0
		let c = canvas.getContext('2d')
		function transform(){
			canvparent1.style.transform = canvparent2.style.transform = "translate("+(x*z*-120+innerWidth/2)+"px, "+(y*z*-120+innerHeight/2)+"px) scale("+z*120+")"
			canvselect.style.transform = "translate("+Math.floor(x)+"px, "+Math.floor(y)+"px) scale(0.01)"
			canvas.style.width = z * canvas.width * 120 + "px"
			canvas.style.height = z * canvas.height * 120 + "px"
			canvas.style.transform = "translate("+x*z*-120+"px, "+y*z*-120+"px)"
		}
		let x, y, z, board, minZoom;
		function setsize(w, h = w){
			canvas.width = w
			canvas.height = h
			canvparent1.style.width = w + "px"
			canvparent1.style.height = h + "px"
			canvparent2.style.width = w + "px"
			canvparent2.style.height = h + "px"
			board = new Uint8Array(w * h).fill(31)
			let i = board.length
			x = +localStorage.x || WIDTH/2
			y = +localStorage.y || HEIGHT/2
			z = +localStorage.z || 0.2
			for(let [k, v] of new URLSearchParams(location.search)){
				v *= 1; if(v != v)continue
				switch(k){
					case 'x': x = v; break
					case 'y': y = v; break
					case 'z': z = v; break
					case 'err': onerror = alert; break
					case 'debug': break
				}
			}
			onresize()
			pos()
		}
		onresize = function(){
			minZoom = Math.min(innerWidth / canvas.width, innerHeight / canvas.height) / 240
			pos()
		}
		let click = false
		let mx, my;
		document.body.onmousemove = function(e){
			if(e.target != document.body && !canvparent2.contains(e.target))return
			moved--
			let dx = -(mx - (mx = e.clientX - innerWidth / 2))
			let dy = -(my - (my = e.clientY - innerHeight / 2))
			if(dx != dx || dy != dy)return
			if(click){
				x -= dx / (z * 120)
				y -= dy / (z * 120)
				pos()
				clearInterval(anim)
			}
		}
		document.body.onwheel = function(e){
			if(e.target != document.body && !canvparent2.contains(e.target))return
			let d = Math.max(minZoom / z, Math.min(0.995 ** e.deltaY, 1 / z))
			z *= d
			x += mx * (d - 1) / z / 120
			y += my * (d - 1) / z / 120
			pos()
		}
		function pos(){
			if(z < minZoom)z = minZoom
			if(z > 1)z = 1
			let right = x - canvas.width + 0.01
			let left = x
			let up = y - canvas.height + 0.01
			let down = y
			if(right >= left) x = 0
			else if(right > 0) x -= right
			else if(left < 0) x -= left
			if(up >= down) y = 0
			else if(up > 0) y -= up
			else if(down < 0) y -= down
			posel.textContent = `(${Math.floor(x)},${Math.floor(y)}) ${z > 0.02 ? Math.round(z*50)/10 : Math.round(z*500)/100}x`
			localStorage.x = Math.floor(x) + 0.5
			localStorage.y = Math.floor(y) + 0.5
			localStorage.z = z
			transform()
		}
		function renderAll(){
			let img = new ImageData(canvas.width, canvas.height)
			let data = new Uint32Array(img.data.buffer)
			let len = board.length
			for(let i = 0; i < len; i++){
				data[i] = PALETTE[board[i]]
			}
			c.putImageData(img, 0, 0)
		}
		let xa = new Uint32Array(1)
		let xb = new Uint8Array(xa.buffer)
		function set(x, y, b){
			board[x % canvas.width + (y % canvas.height) * canvas.width] = b
			xa[0] = PALETTE[b]
			c.fillStyle = "#" + (xb[0] < 16 ? "0" : "") + xb[0].toString(16) + (xb[1] < 16 ? "0" : "") + xb[1].toString(16) + (xb[2] < 16 ? "0" : "") + xb[2].toString(16) + (xb[3] < 16 ? "0" : "") + xb[3].toString(16)
			c.clearRect(x,y,1,1)
			c.fillRect(x,y,1,1)
		}

		document.body.ontouchmove = e => {touchmoved--;for(let t of e.changedTouches){
			clearInterval(anim)
			a: if(!touch2 && touch1 && touch1.identifier == t.identifier){
				if(e.target != document.body && !canvparent2.contains(e.target))break a
				x -= (t.clientX - touch1.clientX) / (z * 120)
				y -= (t.clientY - touch1.clientY) / (z * 120)
				pos()
			}else if(touch1 && touch2){
				if(e.target != document.body && !canvparent2.contains(e.target))break a
				let touch = touch1.identifier == t.identifier ? touch1 : (touch2.identifier == t.identifier ? touch2 : null)
				if(!touch)break a
				let other = touch == touch1 ? touch2 : touch1
				x -= (t.clientX - touch.clientX) / (z * 120)
				y -= (t.clientY - touch.clientY) / (z * 120)
				let dx = touch.clientX - other.clientX
				let dy = touch.clientY - other.clientY
				let a = dx * dx + dy * dy
				dx = t.clientX - other.clientX
				dy = t.clientY - other.clientY
				a = Math.sqrt((dx * dx + dy * dy) / a)
				z *= a
				pos()
			}
			if(touch1 && touch1.identifier == t.identifier)touch1 = t
			else if(touch2 && touch2.identifier == t.identifier)touch2 = t
		}}

		setsize(WIDTH, HEIGHT)
		renderAll()
		let anim = null
		function clicked(clientX, clientY){
			clearInterval(anim)
			clientX = Math.floor(x+(clientX-innerWidth/2)/z/120) + 0.5
			clientY = Math.floor(y+(clientY-innerHeight/2)/z/120) + 0.5
			if(clientX == Math.floor(x) + 0.5 && clientY == Math.floor(y) + 0.5){
				clientX -= 0.5; clientY -= 0.5
				if(CD<Date.now())zoomIn(),showPalette()
				else audios.invalid.run()
				return
			}
			(CD > Date.now() ? audios.invalid : audios.highlight).run()
			anim = setInterval(function(){
				x += (clientX - x) / 10
				y += (clientY - y) / 10
				pos()
				if(Math.abs(clientX - x) + Math.abs(clientY - y) < 0.1)clearInterval(anim)
			},15)
		}
		function zoomIn(){
			if(z >= 0.4)return
			clearInterval(anim)
			let dz = 0.005
			anim = setInterval(function(){
				if(dz < 0.2)dz *= 1.1
				z *= 1 + dz
				pos()
				if(z >= 0.4)clearInterval(anim)
			}, 15)
		}
		let audios = {
			invalid: new Audio('https://hot-potato.reddit.com/media/interactions/invalid.mp3'),
			highlight: new Audio('https://hot-potato.reddit.com/media/interactions/highlight.mp3'),
			selectColor: new Audio('https://hot-potato.reddit.com/media/interactions/select-color.mp3'),
			closePalette: new Audio('https://hot-potato.reddit.com/media/interactions/close-pallette.mp3'),
			cooldownStart: new Audio('https://hot-potato.reddit.com/media/interactions/cooldown-start.mp3'),
			cooldownEnd: new Audio('https://hot-potato.reddit.com/media/interactions/cooldown-end.mp3')
		}
		Audio.prototype.run = function(){
			if(muted)return
			this.currentTime = 0
			this.play()
		}
		let muted = false, unmutedhtml = '<path d="M10.543.5a1.12 1.12 0 00-1.182.117L3.789 4.875h-1.8A1.127 1.127 0 00.868 6v8a1.127 1.127 0 001.125 1.125h1.8l5.572 4.258a1.117 1.117 0 00.681.232 1.128 1.128 0 001.127-1.126V1.511A1.119 1.119 0 0010.543.5zm-.624 17.736l-5.708-4.361H2.118v-7.75h2.093l5.708-4.361zM13 3.375v1.25a5.375 5.375 0 010 10.75v1.25a6.625 6.625 0 000-13.25z"></path><path d="M16.125 10A3.129 3.129 0 0013 6.875v1.25a1.875 1.875 0 010 3.75v1.25A3.129 3.129 0 0016.125 10z"></path>', mutedhtml = '<path d="M19.442 7.442l-.884-.884L16.5 8.616l-2.058-2.058-.884.884L15.616 9.5l-2.058 2.058.884.884 2.058-2.058 2.058 2.058.884-.884L17.384 9.5l2.058-2.058zM10.543.5a1.12 1.12 0 00-1.182.117L3.789 4.875h-1.8A1.127 1.127 0 00.868 6v8a1.127 1.127 0 001.125 1.125h1.8l5.572 4.258a1.117 1.117 0 00.681.232 1.128 1.128 0 001.127-1.126V1.511A1.119 1.119 0 0010.543.5zm-.624 17.736l-5.708-4.361H2.118v-7.75h2.093l5.708-4.361z"></path>'
		mutesvg.innerHTML = unmutedhtml
		let CD = Infinity
		let onCooldown = false
		setInterval(() => {
			let left = Math.floor((CD - Date.now()) / 1000)
			place.innerHTML = load.buffer ? "Downloading image..." : (CD >= 1e100 ? (CD == Infinity ? 'Connecting...' : '<span style="color:#f50">Could not connect!</span>') : left > 0 ? `<svg xmlns="http://www.w3.org/2000/svg" data-name="icons final" viewBox="0 0 20 20" style="height: 1.1rem;vertical-align:top"><path d="M13.558 14.442l-4.183-4.183V4h1.25v5.741l3.817 3.817-.884.884z"></path><path d="M10 19.625A9.625 9.625 0 1119.625 10 9.636 9.636 0 0110 19.625zm0-18A8.375 8.375 0 1018.375 10 8.384 8.384 0 0010 1.625z"></path></svg> ${(''+Math.floor(left/3600)).padStart(2,"0")}:${(''+Math.floor((left/60))%60).padStart(2,"0")}:${(''+left%60).padStart(2,"0")}` : "Place a tile")
			if(CD > Date.now() && !onCooldown && !load.buffer)onCooldown = true
			if(CD < Date.now() && onCooldown && !load.buffer){
				onCooldown = false
				if (!document.hasFocus()) audios.cooldownEnd.run()
			}
		}, 300)

		function showPalette(){
			palette.style.transform = ""
			audios.highlight.play()
		}
		let PEN = -1
		colors.innerHTML = PALETTE.map((a,i)=>`<div style='background:rgba(${a&255},${(a>>8)&255},${(a>>16)&255},1)${a==0xffffffff?";outline:1px #ddd solid;outline-offset:-1px":""}'><span style="background-color: rgba(255, 255, 255, 0.2); border-radius: 20px; width: 15px; height: 15px; position: absolute; text-align: center; line-height: 1; visibility: hidden;"></span></div>`).join('')
		colors.onclick = function(e){
			let i = [...this.children].indexOf(e.target)
			if(i<0)return
			let el = this.children[PEN]
			if(el){
				el.classList.remove('sel')
			}
			PEN = i
			audios.selectColor.run()
			canvselect.style.background = e.target.style.background
			e.target.classList.add('sel')
			pok.classList.add('enabled')
			canvselect.children[0].style.display='none';canvselect.style.outline='8px white solid';canvselect.style.boxShadow='0px 2px 4px 0px rgb(0 0 0 / 50%)'
			hideIndicators();
		}
		function put(){
			if(CD>Date.now())return
			canvselect.style.background='';palette.style.transform='translateY(100%)';colors.children[PEN].classList.remove('sel');pok.classList.remove('enabled')
			set(Math.floor(x), Math.floor(y), PEN)
			canvselect.children[0].style.display='block';canvselect.style.outline='';canvselect.style.boxShadow=''
			audios.cooldownStart.run()
			CD = Date.now() + (localStorage.vip ? (localStorage.vip[0] == '!' ? 0 : COOLDOWN/2) : COOLDOWN)
			let a = new DataView(new Uint8Array(6).buffer)
			a.setUint8(0, 4)
			a.setUint32(1, Math.floor(x) + Math.floor(y) * WIDTH)
			a.setUint8(5, PEN)
			PEN=-1
			ws.send(a)
		}
		function runLengthChanges(data){
			let i = 1, boardI = 0
			while(i < data.byteLength){
				let cell = data.getUint8(i++)
				let c = cell >> 6
				if(c == 1)c = data.getUint8(i++)
				else if(c == 2)c = data.getUint16(i++),i++
				else if(c == 3)c = data.getUint32(i++),i+=3
				boardI += c
				seti(boardI++, cell & 63)
			}
		}
		let load = false
		fetch(localStorage.board || 'place').then(a=>a.arrayBuffer()).then(a => {
			board = new Uint8Array(a)
			renderAll()
			if(load)runLengthChanges(load)
			load = true
		})
		const CHAT_COLOURS = ["lightblue", "navy", "green", "purple", "grey", "brown", "orangered", "gold"]
		let online = 1
		let hash = a => a.split("").reduce((a,b)=>(a*31+b.charCodeAt())>>>0,0)
		let allowed = new Set("rplace.tk google.com wikipedia.org pxls.space".split(" ")), censor = a => a.replace(/fuc?k|shi[t]|c[u]nt/gi,a=>"*".repeat(a.length)).replace(/https?:\/\/(\w+\.)+\w{2,15}(\/\S*)?|(\w+\.)+\w{2,15}\/\S*|(\w+\.)+(tk|ga|gg|gq|cf|ml|fun|xxx|webcam|sexy?|tube|cam|p[o]rn|adult|com|net|org|online|ru|co|info|link)/gi, a => allowed.has(a.replace(/^https?:\/\//,"").split("/")[0]) ? a : "").trim()
		let cMessagesFas = "", cMessagesTu = "", cMessagesEn = ""
		let currentChannel = "fas"

		let ws = new WebSocket((localStorage.server || 'wss://server.rplace.tk:443') + (localStorage.vip ? "/" + localStorage.vip : ""))
		ws.onmessage = async function({data}){
			data = new DataView(await data.arrayBuffer())
			let code = data.getUint8(0)
			if(code == 1){
				CD = data.getUint32(1) * 1000
			}else if(code == 2){
				//run length coding
				if(!load)load = data
				else runLengthChanges(data)
			}else if(code == 7){
				CD = data.getUint32(1) * 1000
				seti(data.getUint32(5), data.getUint8(9))
			}else if(code == 6){
				let i = 0
				while(i < data.byteLength - 2){
					seti(data.getUint32(i += 1), data.getUint8(i += 4))
				}
			}else if(code == 3){
				online = data.getUint16(1)
				document.getElementById("onlineCounter").textContent = online;
			}else if(code == 15){
				let txt = censor(decoder.decode(new Uint8Array(data.buffer).slice(1))).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;");
				let name;
				let messageChannel;
				[txt, name, messageChannel] = txt.split("\n")
				if(name)name = name.replace(/\W+/g,'').toLowerCase()
				let bannedNames = ["nors", "ehe", "burack", "alidark", "thedeath"]
				bannedNames.forEach(bname => {
					if (name == bname) return;
				})
				
				if(!txt)return
				if(txt.includes("ğšğš’ğšœğšŒğš˜ğš›ğš.ğšğš"))return
				if(txt.includes("ğğ¢ğ¬ğœğ¨ğ«ğ.ğ ğ "))return
				if(txt.includes("discord.gg"))return
				if(txt.includes("ğ™™ğ™ğ™¨ğ™˜ğ™¤ğ™§ğ™™.ğ™œğ™œ"))return
				if(txt.includes("ğ’«"))return
				
				let newMessage = document.createElement("div")
				newMessage.innerHTML = `<span style="color: ${CHAT_COLOURS[name ? hash(name) & 7 : (Math.round(Math.random() * 8))]}; cursor: pointer;" onclick="chatMentionUser(this.textContent);">[${name || "anon"}]</span> ${txt}\n`
				let scroll = chatMessages.scrollTop+chatMessages.offsetHeight+10>=chatMessages.scrollHeight

				if (localStorage.name && txt.includes("@" + localStorage.name.replace(/\W+/g,'').toLowerCase())) {
					newMessage.style.backgroundColor = "rgba(255, 255, 0, 0.5)"
					if (currentChannel == messageChannel) audios.closePalette.run()
				}

				if (messageChannel == "en") {
					cMessagesEn = cMessagesEn.concat(newMessage.outerHTML.toString())
				}
				else if (messageChannel == "tu") {
					cMessagesTu = cMessagesTu.concat(newMessage.outerHTML.toString())
				}
				else if (messageChannel == "fas") {
					cMessagesFas = cMessagesFas.concat(newMessage.outerHTML.toString())
				}
				if (currentChannel == messageChannel) {
					chatMessages.insertAdjacentElement("beforeEnd", newMessage)
				}

				if(chatMessages.children.length>100){
                    			chatMessages.children[0].remove()
				}
				scroll && chatMessages.scrollTo(0,999999999)
			}
		}
		ws.onclose = (e) => {
			if(CD != Infinity)return location.replace(location.origin)
			//Something went wrong...
			CD = 1e100
			console.error(e)
		}
		function seti(i, b){
			board[i] = b
			xa[0] = PALETTE[b]
			c.fillStyle = "#" + (xb[0] < 16 ? "0" : "") + xb[0].toString(16) + (xb[1] < 16 ? "0" : "") + xb[1].toString(16) + (xb[2] < 16 ? "0" : "") + xb[2].toString(16) + (xb[3] < 16 ? "0" : "") + xb[3].toString(16)
			c.fillRect(i % WIDTH, Math.floor(i / WIDTH), 1, 1)
		}
		function scanDocumentShortcuts(e) {
			//"Space" key to open server switch menu
			if (e.keyCode == 32 && messageInput != document.activeElement && nameInput != document.activeElement && serverInput != document.activeElement) {
				if (serverMenu.opened) {
					serverInput.blur();
					serverMenu.style.transform =  "translateX(-50%) translateY(-200px)"
					serverMenu.opened = false
				}
				else {
					serverMenu.style.transform = "translateX(-50%)"
					serverMenu.opened = true
				}
			}
			
			//Begin palette commands
			if (onCooldown) return

			//"Enter" key to place selected block without using mouse
			if (e.keyCode == 13 && palette.style.transform == "" && messageInput != document.activeElement && nameInput != document.activeElement && serverInput != document.activeElement) 
				pok.click()

			//Keyboard shortcuts for selecting palette colours
			let keyIndex = null 
			if(document.activeElement != document.body)return
			if (e.keyCode >= 49 && e.keyCode <= 57) keyIndex = e.keyCode - 49
			if (e.keyCode >= 97 && e.keyCode <= 119) keyIndex = e.keyCode - 97 + 9
			if (keyIndex == null) return
			if (palette.style.transform=='translateY(100%)')
				showPalette()
			
			for (let c = 0; c < document.getElementById("colors").children.length; c++) {
				document.getElementById("colors").children[c].firstChild.style.visibility = "visible"
			}

			let i = [...(document.getElementById("colors").children)].indexOf(document.getElementById("colors").children[keyIndex])
			if(i<0) return
			let el = document.getElementById("colors").children[PEN]
			if(el) {
				el.classList.remove('sel')
			}
			PEN = keyIndex;
			audios.selectColor.run()
			canvselect.style.background = document.getElementById("colors").children[keyIndex].style.background
			document.getElementById("colors").children[keyIndex].classList.add('sel')
			pok.classList.add('enabled')
			canvselect.children[0].style.display='none';canvselect.style.outline='8px white solid';canvselect.style.boxShadow='0px 2px 4px 0px rgb(0 0 0 / 50%)'
		}
		function hideIndicators() {
			for (let c = 0; c < document.getElementById("colors").children.length; c++) {
				document.getElementById("colors").children[c].firstChild.style.visibility = "hidden"
			}
		}
		for (let c = 0; c < document.getElementById("colors").children.length; c++) {
			let keybinds = "123456789abcdefghijklmnopqrstuvwxyz"
			let indicator = document.getElementById("colors").children[c].firstChild
			indicator.textContent = keybinds.charAt(c)
		}
		if (window.innerHeight > window.innerWidth) {
			chatPanel.style.transform = "translateX(calc(100% + 50px))"
		}
		function showChat() {
			chatPanel.style.transform = ""
		}
		function hideChat() {
			if (window.innerHeight > window.innerWidth)
				chatPanel.style.transform = "translateX(calc(100% + 50px))"
			else
				chatPanel.style.transform = "translateX(calc(100% + 50px))"
		}
		let encoder = new TextEncoder(), decoder = new TextDecoder()
		function sendMsg(message){
			ws.send(encoder.encode("\x0f" + message + (localStorage.name ? "\n" + localStorage.name : "") + "\n" + currentChannel))
		}
		if (localStorage.name) {
			namePanel.style.visibility = "hidden"
		}
		function setName(name) {
			localStorage.name = name
			namePanel.style.visibility = "hidden"
		}
		
		function switchLanguageChannel(selected) {
			if (selected == "fas") {
				channelNotification.innerText = "Ù„Ø·ÙØ§ Ø§Ø² 'en' Ø¨Ø±Ø§ÛŒ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ 'tu' Ø¨Ø±Ø§ÛŒ ØªØ±Ú©ÛŒ Ùˆ 'far' Ø¨Ø±Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯"
				chatMessages.innerHTML = cMessagesFas
				currentChannel = selected
				channelEn.style.opacity = "0.5"
				channelTu.style.opacity = "0.5"
				channelFas.style.opacity = "1"
			}
			else if(selected == "tu")  {
				channelNotification.innerText = "LÃ¼tfen TÃœ'da TÃ¼rkÃ§e ve EN'de Ä°ngilizce kullanÄ±n."
				chatMessages.innerHTML = cMessagesTu
				currentChannel = selected
				channelEn.style.opacity = "0.5"
				channelTu.style.opacity = "1"
				channelFas.style.opacity = "0.5"
			}
			else if (selected == "en") {
				channelNotification.innerText = "Please use English in EN and Turkish in TÃœ"
				chatMessages.innerHTML = cMessagesEn
				currentChannel = selected
				channelEn.style.opacity = "1"
				channelTu.style.opacity = "0.5"
				channelFas.style.opacity = "0.5"
			}
		}

		function chatMentionUser(formattedName) {
			let user = formattedName.slice(1, -1)
			messageInput.focus()
			let [start, end] = [messageInput.selectionStart, messageInput.selectionEnd]
			messageInput.setRangeText("@" + user, start, end, 'select')
		}

		function switchGameServer() {

		}
		let server = (a,b,x='',l=localStorage)=>{if(!a){l.vip=l.vvip;delete l.vvip;delete l.server;delete l.board;return}l.vvip=l.vvip||l.vip;l.vip=x;l.server=a;l.board=b}
	</script>
	<!--script src="board_final.js"></script-->
</html>
